\section{设计}

该课程设计内容，主要是以{\ja 川合秀実}老师所著《30天自制操作系统》\cite{osask}~一书中介绍的OSASK操作系统为基础的。

代码以C语言和汇编写成，其中汇编是nasm的一个方言NASK，而C语言则是ANSI C，使用gcc编译器可以编译。
编译成为启动镜像文件的\verb|Makefile|适用于Windows平台（可以移植到其他平台），在\verb|z_tools|目录中提供了
所需要的编译程序和链接库。

\lstset{basicstyle=\small\tt}

\subsection{引导程序}
\label{sub:引导程序}

\lstset{language={[x64]Assembler}}

系统存放在一个1.44MB软盘中，其第一扇区为引导程序\verb|ipl10.bin|，作用是将软盘中的前10个柱面读入内存中。

该系统只支持读取FAT12格式，所以首先是格式化的代码。
{\linespread{1}\lstinputlisting[caption={FAT12格式软盘格式化},linerange={10-28}]{osask/src/sys/ipl10.nas}}

下面分别列出了读取一个扇区、18个扇区、10个柱面的汇编代码：
{\linespread{1}\lstinputlisting[caption={读取一个扇区},linerange={40-44,49-62,85-86,102-108}]{osask/src/sys/ipl10.nas}}
{\linespread{1}\lstinputlisting[caption={读取18个扇区},linerange={46-47,64-70}]{osask/src/sys/ipl10.nas}}
{\linespread{1}\lstinputlisting[caption={读取10个柱面},linerange={71-78,82-83,88-96,98-100}]{osask/src/sys/ipl10.nas}}

将磁盘上的内容读入到内存之后，开始载入操作系统内核。我们让操作系统进入图形模式：
{\linespread{1}\lstinputlisting[caption={启动信息},linerange={5-23}]{osask/src/sys/asmhead.nas}}

对于支持VESA BIOS扩展的BIOS，我们进入高分辨率模式（640 x 400 x 8位色）：
{\linespread{1}\lstinputlisting[caption={判断VBE并进入高分辨率模式},linerange={27-73}]{osask/src/sys/asmhead.nas}}
对于不支持VBE的主板，进入低分辨率模式：
{\linespread{1}\lstinputlisting[caption={低分辨率模式},linerange={75-82}]{osask/src/sys/asmhead.nas}}

获取键盘指示灯和屏蔽终端后，开始切换进入32位模式：
{\linespread{1}\lstinputlisting[caption={进入32位模式转存数据},linerange={111-153}]{osask/src/sys/asmhead.nas}}
然后调用主函数，正式启动操作系统：
{\linespread{1}\lstinputlisting[caption={启动bootpack},linerange={157-170,200-201}]{osask/src/sys/asmhead.nas}}

\lstset{language={C}}

操作系统首先初始化中断描述符表、系统FIFO队列、鼠标键盘等：
{\linespread{1}\lstinputlisting[caption={初始化设备},linerange={53-63}]{osask/src/sys/bootpack.c}}

然后初始化内存管理器：
{\linespread{1}\lstinputlisting[caption={初始化内存管理器},linerange={65-68}]{osask/src/sys/bootpack.c}}

初始化调色板和桌面，启动一个默认的终端窗口：
{\linespread{1}\lstinputlisting[caption={初始化桌面},linerange={70-71,77-79,83-84}]{osask/src/sys/bootpack.c}}

初始化鼠标指针：
{\linespread{1}\lstinputlisting[caption={初始化鼠标},linerange={89-94}]{osask/src/sys/bootpack.c}}

接下来进入一个无限循环，该循环查询CPU中断事件，并给与相应：
{\linespread{1}\lstinputlisting[caption={主循环},linerange={104-106,110-113,126-129,136-137,239-239,330-332}]{osask/src/sys/bootpack.c}}


\subsection{设备管理}
\label{sub:设备管理}

\subsection{进程管理}
\label{sub:进程管理}

\subsection{内存管理}
\label{sub:内存管理}

\subsection{文件管理}
\label{sub:文件管理}

\subsection{系统接口}
\label{sub:系统接口}

\subsection{应用程序}
\label{sub:应用程序}
